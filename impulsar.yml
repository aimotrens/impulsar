build:
  jobs:
    - build-linux-amd64
    - build-linux-arm64
    - build-windows-amd64

.build-binary: &build-binary
  shell:
    type: bash
  script:
    - mkdir -p bin
    - go build -o bin/impulsar_${GOOS}_${GOARCH}${EXE_SUFFIX}

build-linux-amd64:
  <<: *build-binary
  variables:
    GOOS: linux
    GOARCH: amd64
    EXE_SUFFIX: ""

build-linux-arm64:
  <<: *build-binary
  variables:
    GOOS: linux
    GOARCH: arm64
    EXE_SUFFIX: ""

build-windows-amd64:
  <<: *build-binary
  variables:
    GOOS: windows
    GOARCH: amd64
    EXE_SUFFIX: ".exe"

# ---

build-docker:
  script:
    - docker build --builder=multiarch --platform=linux/amd64,linux/arm64 -t ${IMAGE} --push .

# ---

install:
  jobs:
    - build-linux-amd64
  script:
    - cp -v bin/impulsar_linux_amd64 ${HOME}/.local/bin/impulsar
